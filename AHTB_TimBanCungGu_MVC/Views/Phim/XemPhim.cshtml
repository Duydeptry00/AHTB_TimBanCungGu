@{
    ViewData["Title"] = "Xem Phim";
    var phan = ViewBag.Phan as AHTB_TimBanCungGu_API.Models.Phan;
    var phimLe = ViewBag.PhimLe as AHTB_TimBanCungGu_API.Models.Phim;
    var phimBo = ViewBag.PhimBo as AHTB_TimBanCungGu_API.Models.Phim;
    var phimDeCu = ViewBag.PhimDeCu as List<AHTB_TimBanCungGu_API.Models.Phim>;
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using Newtonsoft.Json
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
</head>
<style>
    .film-player {
        width: 100%;
        height: 500px;
        background-size: cover;
        background-position: center;
        border-radius: .375rem;
        overflow: hidden;
        margin-bottom: 20px;
    }

    episode-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }

    .episode-buttons button {
        background-color: #383d41;
        border: none;
        cursor: pointer;
        color: #fff;
        font-size: 15px;
        transition: background-color 0.3s ease, transform 0.3s ease;
        width: 60px;
        border-radius: .375rem;
        padding: 5px;
        margin-top: 6px;
    }

        .episode-buttons button:hover {
            background-color: #585c61;
            transform: scale(1.05);
        }

    .card-hover {
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease-in-out;
        background-color: #343a40;
        color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

        .card-hover img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            transition: filter 0.3s ease-in-out;
        }

        .card-hover:hover img {
            filter: brightness(80%);
        }

        .card-hover:hover {
            transform: scale(1.05);
        }

    .card-body {
        padding: 15px;
        text-align: center;
    }

    .btn-xem-ngay {
        position: absolute;
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #dc3545;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 16px;
        cursor: pointer;
        text-align: center;
        white-space: nowrap;
    }

        .btn-xem-ngay i {
            font-size: 1em;
            margin-right: 8px;
            vertical-align: middle;
        }

    .card-hover:hover .btn-xem-ngay {
        opacity: 1;
        pointer-events: auto;
    }

    .card-title {
        font-size: 18px;
        font-weight: bold;
        color: #f8f9fa;
    }
</style>
<body>
    <div class="container my-4">
        <section class="mb-4">
            <h1>
                @if (phimLe != null)
                {
                    @phimLe.TenPhim
                }
                else if (phimBo != null && phan != null)
                {
                    @phimBo.TenPhim @($"(Phần {phan.SoPhan})")
                }
            </h1>

            @if (phimLe != null)
            {
                <div class="film-player">
                    <iframe id="filmPlayer" src="https://vidsrc.dev/embed/movie/@phimLe.SourcePhim" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe>
                </div>
            }
            else if (phimBo != null && phan != null)
            {
                <div class="film-player">
                    <iframe id="filmPlayer" src="https://vidsrc.me/embed/tv?imdb=@phimBo.SourcePhim&season=@phan.SoPhan&episode=1" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe>
                </div>
            }

            @if (phimBo != null && phan != null)
            {
                <div class="episode-buttons">
                    @for (int i = 1; i <= phan.SoLuongTap; i++)
                    {
                        <button onclick="doiTap(@i)">@i</button>
                    }
                </div>
            }

            <div class="mb-4">
                <h2>Mô tả</h2>
                <p>@(phimLe != null ? phimLe.MoTa : (phimBo != null ? phimBo.MoTa : ""))</p>
            </div>
        </section>


        <section class="mb-4">
            <h2>Phim đề cử</h2>
            <div class="row">
                @foreach (var phimdecu in phimDeCu)
                {

                    <div class="col-md-3 mb-4">
                        <div class="card-hover">
                            <img src="/Uploads/@phimdecu.HinhAnh" alt="@phimdecu.TenPhim" class="card-img-top">
                            <div class="card-body">
                                 <h5 class="card-title">@phimdecu.TenPhim</h5>
                                <button class="btn-xem-ngay">
                                    <a asp-controller="Phim" asp-action="ChiTietPhim" asp-route-id="@phimdecu.IDPhim" style="text-decoration: none; color: white;">
                                        <i class="bi bi-play-fill"></i> Xem ngay
                                    </a>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>
    </div>

    <script>
        function doiTap(soTap) {
            const phimLe = "@(phimLe != null ? "true" : "false")";
            const sourcePhim = phimLe === "true" ? "@phimLe?.SourcePhim" : "@phimBo?.SourcePhim";
            const iframe = document.getElementById('filmPlayer');
            if (phimLe === "true") {
                iframe.src = `https://vidsrc.dev/embed/movie/${sourcePhim}`;
            } else {
                const soPhan = "@phan?.SoPhan";
                iframe.src = `https://vidsrc.me/embed/tv?imdb=${sourcePhim}&season=${soPhan}&episode=${soTap}`;
            }
        }
      
    </script>
    <script>
        const socket = new WebSocket('http://localhost:60771/Admin/QuanLyPhim/ConnectWebSocket');

        socket.onmessage = function (event) {
            console.log("Message received: ", event.data);  // In dữ liệu nhận được

            if (event.data) {
                // Kiểm tra nếu người dùng là Premium
                const isPremium = @Html.Raw(JsonConvert.SerializeObject(ViewBag.IsPremium));  // Kiểm tra trạng thái Premium

                if (!isPremium) {
                    Swal.fire({
                        title: 'Thông Báo',
                        html: event.data,  // Hiển thị thông báo phim đã được nâng cấp
                        icon: 'warning',
                        confirmButtonText: 'Đóng',
                        timer: 5000,  // Tự động đóng sau 5 giây
                        timerProgressBar: true,
                        position: 'center',
                        showConfirmButton: false,
                        customClass: {
                            popup: 'swal2-popup-custom',
                        }
                    }).then(() => {
                        // Chuyển hướng về trang chủ sau khi thông báo đóng
                        window.location.href = "/";
                    });
                } else {
                    // Nếu là Premium, không hiển thị thông báo
                    console.log("Người dùng là Premium, không hiển thị thông báo.");
                }
            } else {
                console.log("Không có dữ liệu trong thông báo.");
            }
        };

        socket.onopen = function () {
            console.log("WebSocket is open.");
        };

        socket.onclose = function () {
            console.log("WebSocket closed.");
        };

        socket.onerror = function (error) {
            console.log("WebSocket error:", error);
        };
    </script>

</body>
</html>