@model List<AHTB_TimBanCungGu_API.Chats.ConversationVM>
@{
    ViewData["Title"] = "Danh sách cuộc trò chuyện";
    Layout = null;
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Giao diện chính -->
<div class="messenger-container">
    <!-- Danh sách cuộc trò chuyện -->
    <div class="conversations-list">
        <h3>Danh sách cuộc trò chuyện</h3>
        @if (Model != null && Model.Count > 0)
        {
            @foreach (var conversation in Model)
            {
                <div class="conversation-item" onclick="openConversation('@conversation.user2', '@conversation.hotenuser2')">
                    <strong>Cuộc trò chuyện với:</strong> @conversation.hotenuser2
                    <br />
                    <span>@conversation.contentnew</span>
                    <br />
                </div>
            }
        }
        else
        {
            <p>Không có bạn bè</p>
        }
    </div>

    <!-- Cửa sổ trò chuyện -->
    <div class="chat-window">
        <div class="chat-header">
            <span id="chatTitle">Chọn cuộc trò chuyện để bắt đầu</span>
        </div>
        <div class="chat-body" id="chatBody">
            <!-- Tin nhắn sẽ được thêm vào đây -->
        </div>
        <div class="chat-footer">
            <textarea id="messageContent" placeholder="Gõ tin nhắn..."></textarea>
            <button onclick="sendMessage()" style="background: none; border: none; cursor: pointer;">
                <i class="fas fa-paper-plane" style="font-size: 24px; color: #0078D4;"></i>
            </button>
        </div>
    </div>
</div>

<style>
    /* Cấu hình cơ bản cho toàn bộ trang */
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
    }

    /* Phần chứa chính của messenger */
    .messenger-container {
        display: flex;
        height: 100vh;
    }

    /* Danh sách cuộc trò chuyện */
    .conversations-list {
        width: 30%;
        padding: 10px;
        border-right: 1px solid #ddd;
        overflow-y: auto; /* Thanh cuộn dọc nếu cần */
        height: 100%; /* Chiếm toàn bộ chiều cao */
    }

    /* Mỗi mục cuộc trò chuyện */
    .conversation-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

        .conversation-item:hover {
            background-color: #f5f5f5;
        }

    /* Cửa sổ trò chuyện */
    .chat-window {
        width: 70%;
        display: flex;
        flex-direction: column;
    }

    /* Đầu của cửa sổ trò chuyện */
    .chat-header {
        background-color: #0078D4;
        color: white;
        padding: 10px;
        font-size: 18px;
    }

    /* Phần nội dung của cửa sổ trò chuyện */
    .chat-body {
        flex-grow: 1;
        padding: 10px;
        background-color: #f0f0f0;
        overflow-y: auto; /* Thanh cuộn dọc nếu cần */
        height: calc(100% - 50px); /* Để lại khoảng trống cho phần footer */
    }

        /* Thanh cuộn của chat-body */
        .chat-body::-webkit-scrollbar {
            width: 8px; /* Chiều rộng của thanh cuộn dọc */
            height: 8px; /* Chiều cao của thanh cuộn ngang */
        }

        .chat-body::-webkit-scrollbar-track {
            background: transparent; /* Nền trong suốt */
        }

        .chat-body::-webkit-scrollbar-thumb {
            background: #0078D4; /* Màu của thanh cuộn */
            border-radius: 10px; /* Bo tròn các góc */
            border: 2px solid transparent; /* Đường viền trong suốt */
        }

        .chat-body::-webkit-scrollbar-corner {
            display: none; /* Ẩn phần giao nhau */
        }

        .chat-body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        /* Ẩn các mũi tên cuộn (trong trường hợp có) */
        .chat-body::-webkit-scrollbar-button {
            display: none; /* Ẩn các nút cuộn */
        }
    .chat-body {
        scrollbar-width: thin; /* Thanh cuộn mỏng */
        scrollbar-color: #0078D4 transparent; /* Màu thanh cuộn và nền */
    }

    /* Phần footer của cửa sổ trò chuyện */
    .chat-footer {
        padding: 10px;
        display: flex;
        align-items: center;
    }

        /* Ô nhập liệu */
        .chat-footer textarea {
            width: 100%;
            height: 50px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }

        /* Nút gửi */
        .chat-footer button {
            padding: 10px 20px;
            background-color: #0078D4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .chat-footer button:hover {
                background-color: #005a8e; /* Hiệu ứng khi hover */
            }

    /* Tin nhắn của người dùng và người nhận */
    .user-message, .receiver-message {
        padding: 5px;
        margin: 5px 0;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
    }

    /* Tên người gửi */
    .message-sender {
        font-weight: bold;
        margin-bottom: 3px;
    }

    /* Tin nhắn của người dùng */
    .user-message {
        text-align: right;
        background-color: #d0f0c0;
    }

    /* Tin nhắn của người nhận */
    .receiver-message {
        text-align: left;
        background-color: #f0f0f0;
    }

</style>

<script>
    let currentConversation = null;
    let sendUser = '@ViewBag.CurrentUser';  // Thêm tên người dùng vào ViewBag

    // Khởi tạo kết nối WebSocket
    const socket = new WebSocket('http://localhost:60771/Chats/ConnectWebSocket');  // Đảm bảo URL WebSocket chính xác

    // Khi kết nối WebSocket thành công
    socket.onopen = function () {
        console.log("WebSocket connected.");
    };

    // When a message is received from the WebSocket
    socket.onmessage = function (event) {
        const message = JSON.parse(event.data);  // Parse JSON from server
        const chatBody = document.getElementById("chatBody");

        // Check if the message belongs to the current conversation
        if (message.receiverUsername === currentConversation || message.senderUsername === currentConversation) {
            // Create a container for the message
            let messageContainer = document.createElement("div");
            messageContainer.classList.add(message.senderUsername === sendUser ? "user-message" : "receiver-message");

            // Create the sender's name element
            let senderNameElement = document.createElement("div");
            senderNameElement.classList.add("message-sender");
            senderNameElement.innerText = message.senderName;

            // Create the message content element
            let messageContentElement = document.createElement("div");
            messageContentElement.innerText = message.content;

            // Append the sender's name and message content to the container
            messageContainer.appendChild(senderNameElement);
            messageContainer.appendChild(messageContentElement);

            // Append the message container to the chat body
            chatBody.appendChild(messageContainer);

            // Scroll to the bottom of the chat body when a new message is added
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Optionally reload messages from the API
        loadMessages(currentConversation);
    };

    // Khi WebSocket đóng
    socket.onclose = function () {
        console.log("WebSocket closed.");
    };

    // Khi có lỗi với WebSocket
    socket.onerror = function (error) {
        console.log("WebSocket Error: " + error);
    };

    // Modify the openConversation function to show the chat footer
    function openConversation(user2, hoten) {
        currentConversation = user2;
        document.getElementById("chatTitle").innerText = "Cuộc trò chuyện với: " + hoten;

        // Xóa nội dung tin nhắn cũ
        document.getElementById("chatBody").innerHTML = '';
        // Mở API lấy tin nhắn cho user2
        loadMessages(user2, hoten);

        // Show the chat footer when a conversation is opened
        toggleChatFooter(true);
    }
    window.onload = function () {
        toggleChatFooter(false); // Hide chat footer by default
    };
    // Thêm sự kiện lắng nghe cho ô nhập liệu để xử lý Enter và Shift + Enter
    document.getElementById("messageContent").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            if (event.shiftKey) {
                // Nếu nhấn Shift + Enter, cho phép xuống dòng
                return;
            }
            // Nếu nhấn Enter mà không giữ Shift, gọi hàm gửi tin nhắn
            event.preventDefault(); // Ngăn chặn hành động mặc định của Enter (ví dụ: gửi form)
            sendMessage();
        }
    });
    // Function to toggle the visibility of the chat footer
    function toggleChatFooter(isVisible) {
        const chatFooter = document.querySelector('.chat-footer');
        if (isVisible) {
            chatFooter.style.display = 'flex';
        } else {
            chatFooter.style.display = 'none';
        }
    }
    // Function to load messages from the API
    function loadMessages(user2) {
        if (user2) {
            fetch(`/Chats/GetMessages?receiverUsername=${user2}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (Array.isArray(data.messages) && data.messages.length > 0) {
                            document.getElementById("chatBody").innerHTML = '';  // Clear existing messages
                            console.log(data.messages);
                            data.messages.forEach(message => {
                                let messageContainer = document.createElement("div");
                                messageContainer.classList.add(message.senderUsername === sendUser ? "user-message" : "receiver-message");

                                // Chỉ thêm nội dung tin nhắn mà không hiển thị tên người gửi
                                let messageContentElement = document.createElement("div");
                                messageContentElement.innerText = message.content;

                                // Nếu là tin nhắn gửi từ người nhận, hiển thị tên người nhận
                                if (message.senderUsername !== sendUser) {
                                    let senderNameElement = document.createElement("div");
                                    senderNameElement.classList.add("message-sender");

                                    // Hiển thị tên người nhận nếu không phải người gửi
                                    senderNameElement.innerText = message.receiverName; 
                                    messageContainer.appendChild(senderNameElement);
                                }

                                messageContainer.appendChild(messageContentElement);

                                document.getElementById("chatBody").appendChild(messageContainer);
                            });

                            document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
                        } else {
                            console.log("No messages available.");
                        }
                    } else {
                        console.error("Error loading messages:", data.message);
                    }

                })
                .catch(error => {
                    console.error("Error loading messages:", error);
                });
        } else {
            console.error("Invalid user2.");
        }
    }

    // Gửi tin nhắn qua WebSocket
    async function sendMessage() {
        let messageContent = document.getElementById("messageContent").value;

        // Gửi tin nhắn qua WebSocket
        const message = {
            senderUsername: sendUser,  // Thay thế với thông tin người dùng thực tế
            receiverUsername: currentConversation,
            content: messageContent,
            timestamp: new Date().toISOString()
        };

        socket.send(JSON.stringify(message));  // Gửi tin nhắn tới server qua WebSocket

        // Hiển thị tin nhắn đã gửi trong cửa sổ trò chuyện
        let chatBody = document.getElementById("chatBody");
        let messageElement = document.createElement("div");
        messageElement.classList.add("user-message");
        messageElement.innerText = `${messageContent}`;
        chatBody.appendChild(messageElement);

        // Cuộn tới cuối cùng khi có tin nhắn mới
        chatBody.scrollTop = chatBody.scrollHeight;

        // Xóa nội dung tin nhắn trong textarea
        document.getElementById("messageContent").value = '';
    }
</script>
